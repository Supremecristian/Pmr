<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fuel Totalizer — Fixed Inputs</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --accent:#0ea5e9; --muted:#6b7280; --ok:#059669; --danger:#ef4444;
    --border:#e6eef6;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;}
  body{margin:0;background:var(--bg);color:#0f172a;padding:14px}
  .wrap{max-width:700px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 8px 24px rgba(2,6,23,0.04)}
  label{display:block;font-size:13px;color:#334155;margin-top:8px}
  select,input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);font-size:16px;background:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .controls{display:flex;gap:10px;margin-top:12px}
  .btn{flex:1;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#042433;font-weight:800;cursor:pointer}
  .btn.secondary{background:#fff;border:1px solid var(--border);color:#0f172a}
  .result{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed var(--border);font-weight:700;display:flex;justify-content:space-between}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:center;font-size:14px}
  th{background:#f1f5f9;color:#475569}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:560px){ .grid{grid-template-columns:1fr} .controls{flex-direction:column} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fuel Totalizer</h1>
      <div class="small">Final • Atots </div>
    </header>

    <section class="card" aria-labelledby="calc">
      <div class="grid">
        <div>
          <label for="mode">Mode</label>
          <select id="mode" aria-label="Mode">
            <option value="liters">Liters</option>
            <option value="peso">Peso</option>
            <option value="meter">Meter</option>
          </select>
        </div>
        <div>
          <label for="fuel">Fuel</label>
          <select id="fuel" aria-label="Fuel">
            <option value="ADO1">ADO 1</option>
            <option value="XTRA">Xtra</option>
            <option value="XCS">XCS</option>
            <option value="ADO2">ADO 2</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="price">Price (₱)</label>
          <input id="price" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 57.80">
        </div>
        <div></div>
      </div>

      <div class="grid">
        <div>
          <label for="begin">Beginning</label>
          <input id="begin" type="number" step="0.01" inputmode="decimal" placeholder="Beginning reading">
        </div>
        <div>
          <label for="end">Ending</label>
          <input id="end" type="number" step="0.01" inputmode="decimal" placeholder="Ending reading">
        </div>
      </div>

      <div class="result" id="resultBox" aria-live="polite">
        <div>Liters</div><div id="litersOut">0.00</div>
      </div>
      <div class="result" style="margin-top:8px;">
        <div>Amount (₱)</div><div id="amountOut">0.00</div>
      </div>

      <div class="controls">
        <button id="calcBtn" class="btn">Calculate</button>
        <button id="clearHistoryBtn" class="btn secondary">Clear History</button>
      </div>
      <div class="small" style="margin-top:8px">Inputs (Price, Beginning, Ending) are saved separately for each <b>mode</b> and <b>fuel</b>. ADO1 & ADO2 prices are synced.</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">History</h3>
      <div style="overflow:auto">
        <table id="historyTable" aria-label="History table">
          <thead><tr><th>Fuel</th><th>Mode</th><th>Liters</th><th>Amount (₱)</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
/* ======= integer-safe helpers ======= */
const DEC = 2;
const FACT = 10 ** DEC; // 100

function parseFixed(str){ // parse decimal string -> integer scaled by 100 (e.g. "12.34" -> 1234)
  const s = String(str ?? "").trim();
  if(!s) return 0;
  const neg = s.startsWith('-');
  const clean = s.replace(/[^0-9.-]/g,'');
  const parts = clean.replace('-', '').split('.');
  const intPart = parseInt(parts[0]||'0',10);
  const frac = (parts[1] || '').padEnd(DEC, '0').slice(0,DEC);
  const fracNum = parseInt(frac||'0',10);
  const val = intPart * FACT + fracNum;
  return neg ? -val : val;
}

function toNumberFromInt(i){ return i / FACT; } // e.g. 1234 -> 12.34

function loadDataFromLocal(){
  try{
    const s = localStorage.getItem('totalizer_v4');
    if(!s) return null;
    return JSON.parse(s);
  }catch(e){
    return null;
  }
}

/* ======= storage ======= */
const LS_KEY = 'totalizer_v4';
const DEFAULT_PRICES = { ADO1:57.80, XTRA:54.70, XCS:55.70, ADO2:57.80 };

let store = loadDataFromLocal() || { prices: {...DEFAULT_PRICES}, inputs: { liters: {}, peso: {}, meter: {} }, history: [] };

function persist(){ localStorage.setItem(LS_KEY, JSON.stringify(store)); }

/* ======= UI refs ======= */
const modeEl = document.getElementById('mode');
const fuelEl = document.getElementById('fuel');
const priceEl = document.getElementById('price');
const beginEl = document.getElementById('begin');
const endEl = document.getElementById('end');
const litersOut = document.getElementById('litersOut');
const amountOut = document.getElementById('amountOut');
const historyBody = document.getElementById('historyBody');
const calcBtn = document.getElementById('calcBtn');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

/* ======= load / save per mode+fuel ======= */
function loadForCurrent(){ // load price, begin, end for current mode+fuel
  const fuel = fuelEl.value;
  const mode = modeEl.value;
  // price (shared per fuel; sync ADO1<->ADO2)
  const p = store.prices[fuel] !== undefined ? store.prices[fuel] : DEFAULT_PRICES[fuel];
  priceEl.value = (p !== undefined ? Number(p).toFixed(2) : '');

  // inputs saved per mode->fuel
  const rec = (store.inputs[mode] && store.inputs[mode][fuel]) ? store.inputs[mode][fuel] : null;
  if(rec){
    beginEl.value = rec.begin ?? '';
    endEl.value = rec.end ?? '';
  } else {
    beginEl.value = '';
    endEl.value = '';
  }
  // reset outputs
  litersOut.textContent = '0.00';
  amountOut.textContent = '0.00';
}

function saveInputsAuto(){ // called on input events; saves price and begin/end under mode and fuel
  const fuel = fuelEl.value;
  const mode = modeEl.value;
  const priceStr = priceEl.value;
  const beginStr = beginEl.value;
  const endStr = endEl.value;

  // save price; if editing ADO1 or ADO2, sync both
  const priceNum = parseFloat(priceStr);
  if(!isNaN(priceNum)){
    if(fuel === 'ADO1' || fuel === 'ADO2'){
      store.prices.ADO1 = priceNum;
      store.prices.ADO2 = priceNum;
    } else {
      store.prices[fuel] = priceNum;
    }
  }

  // save inputs per mode->fuel as strings (so exact typed values preserved)
  if(!store.inputs[mode]) store.inputs[mode] = {};
  store.inputs[mode][fuel] = { begin: beginStr, end: endStr };
  persist();
}

/* ======= calculation using integer math ======= */
function calculate(){
  const fuel = fuelEl.value;
  const mode = modeEl.value;
  const priceStr = priceEl.value;
  const beginStr = beginEl.value;
  const endStr = endEl.value;

  if(priceStr === '' || beginStr === '' || endStr === ''){
    alert('Please fill Price, Beginning and Ending.');
    return;
  }

  // parse to integers (scaled by 100)
  const priceInt = parseFixed(priceStr); // centavos per liter
  const beginInt = parseFixed(beginStr); // hundredths of liter or centavos depending
  const endInt = parseFixed(endStr);

  // compute
  let litersInt = 0; // hundredths of liter
  let amountInt = 0; // centavos (money)

  if(mode === 'peso'){ // user provided money values: amount = end - begin (in centavos)
    amountInt = endInt - beginInt;
    if(priceInt === 0){ alert('Price cannot be zero'); return; }
    // liters = amount / price -> litersInt (hundredths) = round((amountInt * 100) / priceInt)
    const raw = (amountInt * FACT) / priceInt;
    litersInt = Math.trunc(raw + 0.5); // round to nearest hundredth
  } else { // liters or meter: liters = end - begin (in hundredths), amount = liters * price
    litersInt = endInt - beginInt;
    // product = litersInt * priceInt (scale 100*100=10000) ; to get centavos (scale 100) divide by 100 with rounding
    const prod = litersInt * priceInt;
    amountInt = Math.trunc((prod + 50) / 100); // round nearest cent
  }

  const liters = toNumberFromInt(litersInt);
  const amount = toNumberFromInt(amountInt);

  // display rounded to 2 decimals
  litersOut.textContent = liters.toFixed(2);
  amountOut.textContent = amount.toFixed(2);

  // save price (sync ado1/ado2)
  const priceNum = Number(parseFloat(priceStr) || 0);
  if(fuel === 'ADO1' || fuel === 'ADO2'){ store.prices.ADO1 = priceNum; store.prices.ADO2 = priceNum; }
  else store.prices[fuel] = priceNum;

  // save inputs per mode->fuel
  if(!store.inputs[mode]) store.inputs[mode] = {};
  store.inputs[mode][fuel] = { begin: beginStr, end: endStr };

  // save history entry
  store.history.push({ fuel, mode, liters: Number(liters.toFixed(2)), amount: Number(amount.toFixed(2)) });
  persist();

  renderHistory();
}

/* ======= history rendering and controls ======= */
function renderHistory(){
  historyBody.innerHTML = '';
  // show most recent first
  const rows = store.history.slice().reverse();
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.fuel}</td><td>${r.mode}</td><td>${(r.liters).toFixed(2)}</td><td>₱${(r.amount).toFixed(2)}</td>`;
    historyBody.appendChild(tr);
  });
}

function clearHistory(){
  if(!confirm('Clear history?')) return;
  store.history = [];
  persist();
  renderHistory();
}

/* ======= wire events ======= */
priceEl.addEventListener('input', saveInputsAuto);
beginEl.addEventListener('input', saveInputsAuto);
endEl.addEventListener('input', saveInputsAuto);
fuelEl.addEventListener('change', ()=>{ loadForCurrent(); });
modeEl.addEventListener('change', ()=>{ loadForCurrent(); });

calcBtn.addEventListener('click', calculate);
clearHistoryBtn.addEventListener('click', clearHistory);

/* ======= init ======= */
// ensure default prices present
store.prices = Object.assign({}, DEFAULT_PRICES, store.prices || {});
persist();
loadForCurrent();
renderHistory();
</script>
</body>
</html>
